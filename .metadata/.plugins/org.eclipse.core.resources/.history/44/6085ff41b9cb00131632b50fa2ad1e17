#INCLUDE "PROTHEUS.CH"
#INCLUDE "TOPCONN.CH"

/*/

ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
ฑฑษออออออออออัออออออออออหอออออออัออออออออออออออออออออหออออออัอออออออออออออปฑฑ
ฑฑบPrograma  ณM41LIOK   บ Autor ณ Douglas Silva      บ Data ณ  09/04/2014 บฑฑ
ฑฑฬออออออออออุออออออออออสอออออออฯออออออออออออออออออออสออออออฯอออออออออออออนฑฑ
ฑฑบDescricao ณ Este programa tem como nใo deixar duplicar itens no pedido บฑฑ
ฑฑบ          ณ de venda                                                   บฑฑ
ฑฑฬออออออออออุออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออนฑฑ
ฑฑบUso       ณ Especifico Editora Pini                                    บฑฑ
ฑฑศออออออออออฯออออออออออออออออออออออออออออออออออออออออออออออออออออออออออออผฑฑ
ฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑฑ
฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿฿
/*/

User Function M410LIOK()       

Private cAliaAnte, nAreaAnte,nRegiAnte, nTES, _TES, nTIPBON, _TIPBON, cTexto, nNotaOrig, _NotaOrig, nSerieOrig, _SerieOrig
Private nCodPro, _CodPro, nItemOri, _ItemOri
Private nPosProduto, nPosPerDesc, nPosPrUnit, nPosPrcVen, nPosBlDesc, nPosPrUnit2, nTipoBonif
Private nRetorno := .T.  
Private nSaldo := 0

cAliaAnte := Alias()                                   
nAreaAnte := IndexOrd()
nRegiAnte := RecNo()
                                                                                 
nPosItem		:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_ITEM" })
nPosProduto 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_PRODUTO" })
nPosPerDesc 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_PERDESC" })
nPosPrUnit 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_PRUNIT" })
nPosQuant 		:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_QTDVEN" })
nPosPrcVen 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_PRCVEN" })
nPosBlDesc 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_BLDESC" })
nPosPrUnit2 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_PRUNIT2" })
nTipoBonif 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_TIPOBON" })
nTipoLocal 	:= aScan(aHeader,{|COLUNA| AllTrim(Upper(COLUNA[2]))=="C6_LOCAL" })

If ACOLS[N,LEN(ACOLS[N])] // Entra se a linha estiver apagada

     nRetorno := .T.
     dbSelectArea(cAliaAnte)
     dbSetOrder(nAreaAnte)
     dbGoTo(nRegiAnte)
     Return(nRetorno)   
     
EndIf

cCodigoP := aCols[n,nPosProduto]
nSaldo := U_CONSSLDO(cCodigoP,aCols[n,nTipoLocal])             

	//Valida็ใo para nใo deixar item duplicado.
	For  nX := 1 To len(aCols)
		If ! ACOLS[N,LEN(ACOLS[N])] 
			If nX != n .And. cCodigoP == aCols[nX,nPosProduto] .And. ! ACOLS[nX,LEN(ACOLS[nX])]  
				Alert("Nใo ้ possivel digitar dois itens com o mesmo c๓digo, favor somar com o item: " +  aCols[nX,nPosItem] ,"M410LIOK") 
				nRetorno := .F.         
	        Endif
	    Endif           
	Next nX
           
	//Valida quantidade em Estoque
	If ! ACOLS[N,LEN(ACOLS[N])] .And. aCols[n,nTipoLocal] == "T5" .or. aCols[n,nTipoLocal] == "T6"
		If  nSaldo < aCols[n,nPosQuant] .And. ! ACOLS[n,LEN(ACOLS[n])]  
			Alert("ATENวรO: Produto: " + ALLTRIM(cCodigoP) + " Nใo contem saldo suficiente para atender este pedido, Saldo: " + cValToChar(nSaldo) ,"M410LIOK") 
			nRetorno := .F.         
        Endif
    Endif           

dbSelectArea(cAliaAnte)
dbSetOrder(nAreaAnte)
dbGoTo(nRegiAnte)  

Return(nRetorno)                              

User Function CONSSLDO(_cCodigo,_cLocal) 

Private nSaldo := 0

cQuery := " SELECT (B2_QATU - B2_RESERVA) AS B2_QATU FROM "+RETSQLNAME("SB2")+" SB2 " 
cQuery += " WHERE SB2.D_E_L_E_T_ != '*' AND SB2.B2_LOCAL IN ('T5', 'T6') AND SB2.B2_COD = '"+_cCodigo+"' "

dbUseArea(.T., "TOPCONN", TCGenQry(, , cQuery), "TRB", .F., .T.)

	nSaldo := TRB->B2_QATU 

TRB->(DBCLOSEAREA("TRB"))

Return(nSaldo)